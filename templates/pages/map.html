{% extends 'partials/base.html' %}
{% block header %}
    <!-- boostrap select -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>

    <!-- Cesium JS -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.90/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.90/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        .cesium-widget-credits{
            display:none !important;
        }
    </style>
{% endblock header %}
{% block content %}
<div class="mapwrapper">
    <div id="cesiumContainer"></div>
    <div class="dep_select_div">
        <select id="deployment_selector" name="deployment_selector" class="selectpicker" data-live-search="true" multiple>
        </select>
    </div>
</div>
{% endblock %}
{% block footer %}
<script>
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJmMGVmNzRhYi0xYmYzLTQzMzMtODgyOC03YzNkYzhiMGNmY2YiLCJpZCI6ODIwOTksImlhdCI6MTY0NDUxODc2MH0.EsUnOM3XA-Mt1Mw-X9dlcbZrO_zEhORXCPTLpyG-ibc';  

    //Starting camera position and home button
    var rectangle = Cesium.Rectangle.fromDegrees(-40, 30, -40, 30); //W, S, E, N
    Cesium.Camera.DEFAULT_VIEW_FACTOR = 3;
    Cesium.Camera.DEFAULT_VIEW_RECTANGLE = rectangle;

    //Map viewer object
    const viewer = new Cesium.Viewer('cesiumContainer', {
        geocoder: true,
        homeButton: true,
        sceneModePicker: false,
        baseLayerPicker: false,
        fullscreenButton: true,
        navigationHelpButton: false,
        animation: false,
        timeline: false,
        fulllscreenButtond: false,
        vrButton: false,
        infoBox: true
    });

    //Allows js to run in infobox (link to float detail page)
    viewer.infoBox.frame.setAttribute("sandbox", "allow-same-origin allow-popups allow-forms allow-scripts");
    viewer.infoBox.frame.src = "about:blank";

    function update_map(deployments){
    //Function to update the map by first removing everything, then adding back new deployment seleciton lines and points
        $.ajax({
            type: 'GET',
            url: "ajax/map_data",
            data: {"deployments": deployments},
            success: function (response) {
                //If sucessful, add points and lines
                viewer.entities.removeAll(); //Remove all lines and points
                response['results'].forEach(function (item, index){
                    add_points(item) //Add points
                    add_lines(item)
                })
            },
            error: function (response) {
                console.log(response)
            }
        })
    }

    function add_points(deployment){
    //Adds points to map

        console.log(deployment['sn'])
        //Points
        var float = viewer.entities.add({
            name : deployment['sn'],
            position : Cesium.Cartesian3.fromDegrees(deployment['long'], deployment['lat']),
            point : {
                pixelSize : 8,
                color : Cesium.Color.fromCssColorString('#ffd30fff'),
                outlineColor : Cesium.Color.BLACK,
                outlineWidth : 1
            },
            label : {
                text : deployment['sn'],
                font : '12pt arial',
                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                outlineWidth : 2,
                verticalOrigin : Cesium.VerticalOrigin.BOTTOM,
                pixelOffset : new Cesium.Cartesian2(0, -9)
            }
        })

        //Info box
        float.name = deployment['sn']
        float.description = '<h3>WMO</h3><p>'+deployment['wmo']+'</p>'+
            '<h3>Current Position</h3>'+
            '<p>Lat: '+deployment['lat']+' Long: '+deployment['long']+'</p>'+
            "<a target='_blank' href='/float_detail?FLOAT_SERIAL_NO="+deployment['sn']+"&PLATFORM_TYPE=NAVIS_EBR'>Float Detail Page</a>";
    }

    function add_lines(deployment){
        //Lines
        var entity = viewer.entities.add({
            polyline : {
                positions : Cesium.Cartesian3.fromDegreesArray(deployment['hist_positions']),
            width : 2,
        }});

        var polyline = entity.polyline // For upcoming examples

        polyline.material = new Cesium.PolylineGlowMaterialProperty({
            glowPower : .5,
            color : Cesium.Color.BLUE
        });
    }










    //Populate deployment list
    $.ajax({
        type: 'GET',
        url: "ajax/get_deployments_list",
        success: function (response) {
            //If sucessful
            let deployments = []
            $.each(response.deployments, function(index, item) {
                let opt = document.createElement("option");
                opt.textContent = item.LABEL;
                opt.value =item.PLATFORM_NUMBER;
                $("#deployment_selector").append(opt);
                deployments.push(item.PLATFORM_NUMBER)
                $('select[name=deployment_selector]').val(deployments);
                $('.selectpicker').selectpicker('refresh')
            })


            //Initial load
            update_map(deployments)
        },
        error: function (response) {
            console.log(response)
        }
    })

    //Change with deployment selection
    $("#deployment_selector").change(function (e) {
        e.preventDefault();
        //get selectors
        var deployments = $(this).val();
        update_map(deployments)
    })

</script>
{% endblock footer %}
