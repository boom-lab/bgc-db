{% extends 'partials/base.html' %}
{% block header %}
    <!-- boostrap select -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    
    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <!--noUISlider-->
    <link href="static/css/nouislider.min.css" rel="stylesheet">

{% endblock header %}
{% block content %}
<script src="static/js/nouislider.min.js"></script>

<div class="container-fluid">
    <div class="row">
        <!-- Controls -->
        <div class="col-1">
            <label>Cohort</label>
            <div class="row">
                <select id="year_selector" class="selectpicker" aria-label="select">
                    <option value=2021 selected>2021</option>
                </select>
            </div>
            <label>Variable</label>
            <div class="row">
                <select id="var_selector" class="selectpicker" aria-label="select">
                    <option value="PSAL" selected>Salinity</option>
                    <option value="TEMP">Temperature</option>
                    <option value="DOXY">Dissolved Oxygen</option>
                    <option value="PH_IN_SITU_TOTAL">pH</option>
                    <option value="CHLA">Chlorophyll a</option>
                    <option value="BBP700">Particle Backscatter</option>
                    <option value="CDOM">CDOM</option>
                    <option value="NITRATE">Nitrate</option>
                </select>
            </div>           
        </div>
        
        <!-- Plots -->
        <div class="col">
            <div id="slider"></div>
            <div class="spinner-border" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <div id="graph"></div>
        </div>
    </div>
</div>
{% endblock %}
{% block footer %}
<script>
    //Update plot
    function update(year_selected, var_selected, start, end){

        $.ajax({
            type: 'GET',
            url: "ajax/update_cohort_plot",
            data: {"year_selected": year_selected, "var_selected":var_selected, "start":start,"end":end},
            success: function (response) {
                //If sucessful, add plot
                $('#graph').show();
                $('#graph').html(response["plot_div"])
                $('.spinner-border').hide();
            },
            error: function (response) {
                console.log(response)
            }
        })
    }

    //Initial load
    let var_selected = $("#var_selector").val();
    let year_selected = $("#year_selector").val();
    update(year_selected, var_selected, 1, 365)

    //Change with var selection
    $("#var_selector").change(function (e) {
        e.preventDefault();
        //Unhide loading spinner
        $('#graph').hide();
        $('.spinner-border').show();
        //get selectors
        let var_selected = $("#var_selector").val();
        let year_selected = $("#year_selector").val();
        let slider_vals = document.getElementById('slider').noUiSlider.get();
        //update plot
        update(year_selected, var_selected, slider_vals[0], slider_vals[1])
    })

    //Change with year selection
    $("#year_selector").change(function (e) {
        e.preventDefault();
        //Unhide loading spinner
        $('#graph').hide();
        $('.spinner-border').show();
        //get selectors
        let var_selected = $("#var_selector").val();
        let year_selected = $("#year_selector").val();
        let slider_vals = document.getElementById('slider').noUiSlider.get();
        //update plot
        update(year_selected, var_selected, slider_vals[0], slider_vals[1])
    })

    var range_all_sliders = {
        'min': [     1 ],
        'max': [ 365 ]
    };
    
    function format_date(day){
        let month = day
        if (day==1){
            month='January';
        }
        return month
    }

    //Create slider
    var slider = document.getElementById('slider');

    noUiSlider.create(slider, {
        start: [1, 365],
        connect: true,
        step: 1,
        range: {
            'min': 1,
            'max': 365
        },
        range: range_all_sliders,
        pips: {
            mode: 'values',
            values: [1, 60,121,182,244,305,365],
            density: 8,
            stepped: true,
            format: {
                to: function (value) {
                    value = Math.round(value)
                    let month = value
                    if (value==1){
                        month='Jan';
                    }
                    if (value==60){
                        month='Mar';
                    }
                    if (value==121){
                        month='May';
                    }
                    if (value==182){
                        month='Jul';
                    }
                    if (value==244){
                        month='Sep';
                    }
                    if (value==305){
                        month='Nov';
                    }
                    if (value==365){
                        month='Jan';
                    }
                    return month
                },
                // 'from' the formatted value.
                // Receives a string, should return a number.
                from: function (value) {
                    return Number(value.replace(',-', ''));
                }
            }
        }
    });


    //Slider change
    slider.noUiSlider.on('end', function (values, handle) {
        //Unhide loading spinner
        $('#graph').hide();
        $('.spinner-border').show();
        //get selectors
        let var_selected = $("#var_selector").val();
        let year_selected = $("#year_selector").val();
        //update plot
        update(year_selected, var_selected, values[0], values[1])
    });



</script>
{% endblock footer %}